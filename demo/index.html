<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Whisper-to-Cards — Demo</title>
  <link rel="icon" href="./assets/aw2c.jpeg" type="image/jpeg+xml">
  <link rel="shortcut icon" href="./assets/aw2c.jpeg" type="image/svg+xml">
  <meta name="theme-color" content="#0b0f1a">
  <style>
    :root { color-scheme: dark light; }
    body { font: 16px/1.5 system-ui, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#0b0f1a; color:#e6e6e6; }
    a { color:#9bd; }
    .wrap { max-width:1100px; margin: 40px auto; padding: 0 16px; }
    .h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
    .muted { color:#9aa4b2; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr 340px; }
    .card { background:#101827; border:1px solid #223; border-radius:14px; padding:16px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button { padding:8px 12px; border-radius:10px; border:1px solid #355; background:#142033; color:#e6e6e6; cursor:pointer; }
    button:disabled { opacity:.6; cursor:default; }
    .links a { display:inline-block; margin-right:10px; }
    iframe { width:100%; height:70vh; border:0; border-radius:10px; background:#0b0f1a; }
    .ok { color:#a7f3d0; }
    .err { color:#fca5a5; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">Whisper-to-Cards — Demo</div>
    <div class="muted">Upload a lecture → get accessible notes + study decks.</div>

    <div class="grid" style="margin-top:16px;">
      <!-- Left: live notes preview (from Supabase once ready) -->
      <div class="card">
        <div class="row" style="justify-content:space-between; margin-bottom:10px;">
          <div style="font-weight:600">Notes Preview</div>
          <div class="muted" id="status">Idle</div>
        </div>
        <iframe id="notesFrame" title="Notes preview (cloud)"></iframe>
                src="../outputs/notes.html"></div>iframe>
      </div>

      <!-- Right: uploader + links -->
      <div class="card">
        <div style="font-weight:600; margin-bottom:8px;">Upload & Process</div>
        <div class="row" style="margin-bottom:8px;">
          <input id="file" type="file" accept=".mp3,.m4a,.wav,.flac,.aac,.ogg" />
          <button id="send">Upload</button>
        </div>
        <div class="muted" id="progress">Choose a file and click Upload.</div>
        <hr style="border-color:#223; margin:12px 0;">
        <div style="font-weight:600; margin-bottom:6px;">Downloads</div>
        <div class="links" id="links">
          <hr style="border-color:#223; margin:12px 0;">
          <div style="font-weight:600; margin-bottom:6px;">Last commit (repo)</div>
          <div class="links">
            <a href="../outputs/notes.html" target="_blank">Notes</a>
            <a href="../outputs/notes.pdf"  target="_blank">PDF</a>
            <a href="../outputs/deck.csv"   target="_blank">CSV</a>
            <a href="../outputs/deck.apkg"  target="_blank">Anki</a>
            <a href="../dist/lecture_easyread.zip" target="_blank">ZIP</a>
          </div>
        </div>
        <div style="margin-top:10px" class="muted">
          Tip: keep the API & worker running in Codespaces. This page is static.
        </div>
      </div>
    </div>
  </div>

  <!-- Uploader script -->
  <script>
    // ⬅️ Set this to your FastAPI public URL shown in the Codespaces Ports panel
    const API_BASE = "https://psychic-giggle-666p44v5jpr3r75p-8080.app.github.dev";

    const fileEl = document.getElementById('file');
    const sendEl = document.getElementById('send');
    const statusEl = document.getElementById('status');
    const progressEl = document.getElementById('progress');
    const linksEl = document.getElementById('links');
    const notesFrame = document.getElementById('notesFrame');

    async function signUpload(name, type) {
      const r = await fetch(`${API_BASE}/sign-upload`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ filename: name, content_type: type || "application/octet-stream" })
      });
      if (!r.ok) throw new Error("sign failed");
      return r.json();
    }
    async function putSigned(url, file) {
      const r = await fetch(url, { method: "PUT", body: file, headers: { "content-type": file.type || "application/octet-stream", "x-upsert": "true" }});
      if (!r.ok) throw new Error("upload failed");
    }
    async function poll(job_id, ms=5000) {
      for (;;) {
        const r = await fetch(`${API_BASE}/status?job_id=` + encodeURIComponent(job_id));
        const j = await r.json();
        if (j.status === "complete") return j;
        if (j.status === "error") throw new Error(j.error || "processing error");
        await new Promise(s => setTimeout(s, ms));
      }
    }
    function setLinks(outputs) {
      linksEl.innerHTML = "";
      const order = [["notes.html","Notes"],["notes.pdf","PDF"],["deck.apkg","Anki"],["deck.csv","CSV"],["bundle.zip","ZIP"]];
      for (const [key,label] of order) {
        if (outputs[key]) {
          const a = document.createElement('a');
          a.href = outputs[key]; a.target = "_blank"; a.textContent = label;
          linksEl.appendChild(a);
        }
      }
      if (outputs["notes.html"]) notesFrame.src = outputs["notes.html"];
    }

    sendEl.onclick = async () => {
      const f = fileEl.files[0];
      if (!f) { progressEl.textContent = "Choose a file first."; return; }
      try {
        sendEl.disabled = true;
        statusEl.textContent = "Queued…"; progressEl.textContent = "Requesting signed URL…";
        const { ok, job_id, upload_url } = await signUpload(f.name, f.type);
        if (!ok) throw new Error("sign failed");
        progressEl.textContent = "Uploading to cloud storage…";
        await putSigned(upload_url, f);
        statusEl.textContent = "Processing…"; progressEl.textContent = "This may take a while (transcribe → segment → render → deck).";
        const job = await poll(job_id);
        statusEl.innerHTML = "<span class='ok'>Done</span>";
        progressEl.textContent = "Links ready.";
        setLinks(job.outputs || {});
      } catch (e) {
        statusEl.innerHTML = "<span class='err'>Error</span>";
        progressEl.textContent = e.message || "Something went wrong.";
      } finally {
        sendEl.disabled = false;
      }
    };
  </script>
</body>
</html>
